<!DOCTYPE html>
<html>
<head>
  <title>Customer Orders - Nested Table</title>
  
  <!-- Tabulator CSS & JS -->
  <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #f9f9f9;
    }

    h2 {
      color: #333;
    }

    #main-table {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .sub-table {
      padding: 10px;
      background-color: #f4f4f4;
      border: 1px solid #ccc;
      margin: 10px 0;
      border-radius: 5px;
    }

    .expand-btn {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    .expand-btn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <h2>Customer Orders</h2>
  <div id="main-table"></div>

  <script>
    // Sample data
    const rawData = [
      {
        CustomerID: "CUST001",
        CustomerName: "Alice",
        ProductName: "Laptop",
        OrderDate: "2023-06-01",
        Sales: 1500,
        Profit: 300,
      },
      {
        CustomerID: "CUST001",
        CustomerName: "Alice",
        ProductName: "Mouse",
        OrderDate: "2023-06-05",
        Sales: 50,
        Profit: 10,
      },
      {
        CustomerID: "CUST002",
        CustomerName: "Bob",
        ProductName: "Keyboard",
        OrderDate: "2023-06-10",
        Sales: 100,
        Profit: 20,
      },
      {
        CustomerID: "CUST003",
        CustomerName: "Charlie",
        ProductName: "Monitor",
        OrderDate: "2023-06-15",
        Sales: 300,
        Profit: 60,
      }
    ];

    // Group orders by Customer
    const grouped = {};
    rawData.forEach(row => {
      if (!grouped[row.CustomerID]) {
        grouped[row.CustomerID] = {
          CustomerID: row.CustomerID,
          CustomerName: row.CustomerName,
          Orders: []
        };
      }
      grouped[row.CustomerID].Orders.push({
        ProductName: row.ProductName,
        OrderDate: row.OrderDate,
        Sales: row.Sales,
        Profit: row.Profit
      });
    });

    const tableData = Object.values(grouped);

    // Create Main Tabulator Table
    new Tabulator("#main-table", {
      data: tableData,
      layout: "fitColumns",
      height: "600px",
      columns: [
        { title: "Customer ID", field: "CustomerID" },
        { title: "Customer Name", field: "CustomerName" },
        {
          title: "View Orders",
          formatter: () => "<button class='expand-btn'>Expand</button>",
          width: 120,
          cellClick: function (e, cell) {
            const existing = cell.getRow().getElement().nextSibling;
            if (existing && existing.classList.contains("sub-table")) {
              existing.remove(); // collapse if already opened
              return;
            }

            // Close others
            document.querySelectorAll(".sub-table").forEach(el => el.remove());

            const orders = cell.getRow().getData().Orders;
            const wrapper = document.createElement("div");
            wrapper.className = "sub-table";
            cell.getRow().getElement().after(wrapper);

            new Tabulator(wrapper, {
              data: orders,
              layout: "fitColumns",
              autoColumns: true,
              height: "auto"
            });
          }
        }
      ]
    });
  </script>
</body>
</html>
